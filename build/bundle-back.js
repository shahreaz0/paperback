!function(e){var r={};function o(t){if(r[t])return r[t].exports;var a=r[t]={i:t,l:!1,exports:{}};return e[t].call(a.exports,a,a.exports,o),a.l=!0,a.exports}o.m=e,o.c=r,o.d=function(e,r,t){o.o(e,r)||Object.defineProperty(e,r,{enumerable:!0,get:t})},o.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},o.t=function(e,r){if(1&r&&(e=o(e)),8&r)return e;if(4&r&&"object"==typeof e&&e&&e.__esModule)return e;var t=Object.create(null);if(o.r(t),Object.defineProperty(t,"default",{enumerable:!0,value:e}),2&r&&"string"!=typeof e)for(var a in e)o.d(t,a,function(r){return e[r]}.bind(null,a));return t},o.n=function(e){var r=e&&e.__esModule?function(){return e.default}:function(){return e};return o.d(r,"a",r),r},o.o=function(e,r){return Object.prototype.hasOwnProperty.call(e,r)},o.p="",o(o.s=4)}([function(e,r){e.exports=require("express")},function(e,r,o){const t=o(2),a=t.Schema({title:{type:String,required:!0},description:{type:String,required:!0},publishDate:{type:Date,required:!0},coverImage:{type:Buffer},coverImageType:{type:String},author:{type:t.Schema.Types.ObjectId,ref:"Author"}},{timestamps:!0});a.virtual("imagePath").get((function(){if(book=this,book.coverImage&&book.coverImageType)return`data:${book.coverImageType};base64,${book.coverImage.toString("base64")}`})),e.exports=t.model("Book",a)},function(e,r){e.exports=require("mongoose")},function(e,r,o){const t=o(2),a=o(1),n=t.Schema({name:{type:String,required:!0}});n.pre("remove",(function(e){a.find({author:this}).then(r=>{r.length?e(new Error("This author has books")):e()}).catch(r=>e(r))})),e.exports=t.model("Author",n)},function(e,r,o){e.exports=o(5)},function(e,r,o){const t=o(6),a=o(14),n=o(15);var i=process.env.PORT||"3000";t.set("port",i),a.createServer(t).listen(i,()=>{console.log(n.blue("======================")),console.log(n.bold("Listening at port "+n.bold.red(i))),console.log(n.blue("======================"))})},function(e,r,o){const t=o(7),a=o(0),n=o(8);o(9);const i=o(11),s=o(12),c=o(13),u=a();u.set("views",t.join("views")),u.set("view engine","ejs"),u.use(a.json({limit:"50mb"})),u.use(a.urlencoded({limit:"50mb",extended:!1})),u.use(a.static(t.join("public"))),u.use(n("_method")),u.use(i),u.use(s),u.use(c),e.exports=u},function(e,r){e.exports=require("path")},function(e,r){e.exports=require("method-override")},function(e,r,o){o(10).config();const t=o(2);t.connect(process.env.DB_URL,{useNewUrlParser:!0,useUnifiedTopology:!0}).catch(e=>console.log(e));const a=t.connection;a.on("error",e=>console.log(e)),a.once("open",()=>console.log("Connected to mongoose!!"))},function(e,r){e.exports=require("dotenv")},function(e,r,o){const t=o(0),a=o(1),n=t.Router();n.get("/",async(e,r)=>{try{const o=await a.find().sort({publishDate:"desc"}).limit(10).exec();r.render("home",{pageTitle:"Paperback",books:o,path:e.path})}catch(e){r.render("error",{pageTitle:"Error",backButton:"/"})}}),e.exports=n},function(e,r,o){const t=o(0).Router(),a=o(3),n=o(1);t.get("/authors",async(e,r)=>{try{let o={};if(e.query.authorName){const r=new RegExp(e.query.authorName,"i");o.name=r}const t=await a.find(o);r.render("authors/index",{pageTitle:"Authors",authors:t,query:e.query.authorName,path:e.path})}catch(e){r.render("error",{error:e})}}),t.get("/authors/new",(e,r)=>{r.render("authors/new",{pageTitle:"Add Author",path:e.path})}),t.post("/authors",async(e,r)=>{try{if(!e.body.authorName)throw"Enter author name.";const o=new a({name:e.body.authorName});await o.save(),r.redirect("/authors")}catch(e){r.render("error",{pageTitle:"Error",error:e,backButton:"/authors/new"})}}),t.get("/authors/:id",async(e,r)=>{try{const o=await a.findById(e.params.id),t=await n.find({author:o._id});r.render("authors/show",{pageTitle:o.name,author:o,booksByAuthor:t})}catch(e){r.render("error",{error:e})}}),t.put("/authors/:id",async(e,r)=>{try{const o=await a.findById(e.params.id);o.name=e.body.authorName,await o.save(),r.redirect("/authors/"+e.params.id)}catch(e){r.render("error",{error:e})}}),t.get("/authors/:id/edit",async(e,r)=>{try{const o=await a.findById(e.params.id);r.render("authors/edit",{pageTitle:"Edit "+o.name,author:o})}catch(e){r.render("error",{error:e})}}),t.delete("/authors/:id",async(e,r)=>{try{const o=await a.findById(e.params.id);await o.remove(),r.redirect("/authors")}catch(e){r.render("error",{error:e,backButton:"/authors"})}}),e.exports=t},function(e,r,o){const t=o(0).Router(),a=o(1),n=o(3);t.get("/books",async(e,r)=>{try{let o=a.find();e.query.title&&(o=o.where("title").regex(new RegExp(e.query.title,"i"))),e.query.publishAfter&&(o=o.where("publishDate").gte(e.query.publishAfter)),e.query.publishBefore&&(o=o.where("publishDate").lte(e.query.publishBefore));const t=await o.exec();r.render("books/index",{pageTitle:"Books",path:e.path,searchOptions:e.query,books:t})}catch(e){r.render("error",{backButton:"/books",error:e})}}),t.get("/books/new",async(e,r)=>{const o=await n.find({});r.render("books/new",{pageTitle:"Add Book",path:e.path,authors:o})}),t.post("/books",async(e,r)=>{const o=["bookTitle","bookDescription","bookPublishDate","bookAuthor"];try{o.forEach(r=>{if(!e.body[r])throw"Enter "+r});const t=new a({title:e.body.bookTitle,description:e.body.bookDescription,publishDate:e.body.bookPublishDate,author:e.body.bookAuthor});i(t,e.body.cover),await t.save(),r.redirect("/books")}catch(e){r.render("error",{pageTitle:"Error",error:e,backButton:"/books/new"})}}),t.get("/books/:id",async(e,r)=>{try{const o=await(await a.findById(e.params.id).populate("author")).execPopulate();r.render("books/show",{pageTitle:o.title,book:o})}catch(e){r.render("error",{backButton:"/books",error:e})}}),t.get("/books/:id/new",async(e,r)=>{try{const o=await a.findById(e.params.id),t=await n.find({});r.render("books/edit",{pageTitle:"Edit "+o.title,book:o,authors:t})}catch(e){r.render("error",{backButton:"/books",error:e})}}),t.put("/books/:id",async(e,r)=>{try{const o=await a.findById(e.params.id);o.title=e.body.bookTitle||o.title,o.description=e.body.bookDescription||o.description,e.body.bookPublishDate&&(o.publishDate=new Date(e.body.bookPublishDate)),o.author=e.body.bookAuthor||o.author,i(o,e.body.cover),await o.save(),r.redirect("/books/"+e.params.id)}catch(o){r.render("error",{pageTitle:"Error",error:o,backButton:`/books/${e.params.id}/new`})}}),t.delete("/books/:id",async(e,r)=>{try{const o=await a.findById(e.params.id);await o.remove(),r.redirect("/books")}catch(o){r.render("error",{pageTitle:"Error",error:o,backButton:"/books/"+e.params.id})}});const i=(e,r)=>{if(!e||!r)return new Error("Something wrong with file upload.Try again.");{const o=JSON.parse(r),t=["image/jpeg","image/jpg","image/png","image/gif"];o&&t.includes(o.type)&&(e.coverImage=new Buffer.from(o.data,"base64"),e.coverImageType=o.type)}};e.exports=t},function(e,r){e.exports=require("http")},function(e,r){e.exports=require("chalk")}]);