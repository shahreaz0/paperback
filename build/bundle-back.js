!function(e){var r={};function t(o){if(r[o])return r[o].exports;var n=r[o]={i:o,l:!1,exports:{}};return e[o].call(n.exports,n,n.exports,t),n.l=!0,n.exports}t.m=e,t.c=r,t.d=function(e,r,o){t.o(e,r)||Object.defineProperty(e,r,{enumerable:!0,get:o})},t.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},t.t=function(e,r){if(1&r&&(e=t(e)),8&r)return e;if(4&r&&"object"==typeof e&&e&&e.__esModule)return e;var o=Object.create(null);if(t.r(o),Object.defineProperty(o,"default",{enumerable:!0,value:e}),2&r&&"string"!=typeof e)for(var n in e)t.d(o,n,function(r){return e[r]}.bind(null,n));return o},t.n=function(e){var r=e&&e.__esModule?function(){return e.default}:function(){return e};return t.d(r,"a",r),r},t.o=function(e,r){return Object.prototype.hasOwnProperty.call(e,r)},t.p="",t(t.s=4)}([function(e,r){e.exports=require("express")},function(e,r,t){const o=t(2),n=o.Schema({title:{type:String,required:!0},description:{type:String,required:!0},publishDate:{type:Date,required:!0},coverImage:{type:Buffer},coverImageType:{type:String},author:{type:o.Schema.Types.ObjectId,ref:"Author"}},{timestamps:!0});n.virtual("imagePath").get((function(){if(book=this,book.coverImage&&book.coverImageType)return`data:${book.coverImageType};base64,${book.coverImage.toString("base64")}`})),e.exports=o.model("Book",n)},function(e,r){e.exports=require("mongoose")},function(e,r,t){const o=t(2),n=t(1),a=o.Schema({name:{type:String,required:!0}});a.pre("remove",(function(e){n.find({author:this}).then(r=>{r.length?e(new Error("This author has books")):e()}).catch(r=>e(r))})),e.exports=o.model("Author",a)},function(e,r,t){e.exports=t(5)},function(e,r,t){const o=t(6),n=t(14),a=t(15);var i=process.env.PORT||"3000";o.set("port",i),n.createServer(o).listen(i,()=>{console.log(a.blue("======================")),console.log(a.bold("Listening at port "+a.bold.red(i))),console.log(a.blue("======================"))})},function(e,r,t){const o=t(7),n=t(0),a=t(8);t(9);const i=t(11),s=t(12),u=t(13),c=n();c.set("views",o.join("views")),c.set("view engine","ejs"),c.use(n.json({limit:"50mb"})),c.use(n.urlencoded({limit:"50mb",extended:!1})),c.use(n.static(o.join("public"))),c.use(a("_method")),c.use(i),c.use(s),c.use(u),e.exports=c},function(e,r){e.exports=require("path")},function(e,r){e.exports=require("method-override")},function(e,r,t){t(10).config();const o=t(2);o.connect(process.env.DB_URL,{useNewUrlParser:!0,useUnifiedTopology:!0}).catch(e=>console.log(e));const n=o.connection;n.on("error",e=>console.log(e)),n.once("open",()=>console.log("Connected to mongoose!!"))},function(e,r){e.exports=require("dotenv")},function(e,r,t){const o=t(0),n=t(1),a=o.Router();a.get("/",async(e,r)=>{try{const e=await n.find().sort({publishDate:"desc"}).limit(10).exec();r.render("home",{pageTitle:"Paperback",books:e})}catch(e){r.render("error",{pageTitle:"Error",backButton:"/"})}}),e.exports=a},function(e,r,t){const o=t(0).Router(),n=t(3),a=t(1);o.get("/authors",async(e,r)=>{try{let t={};if(e.query.authorName){const r=new RegExp(e.query.authorName,"i");t.name=r}const o=await n.find(t);r.render("authors/index",{pageTitle:"Authors",authors:o,query:e.query.authorName})}catch(e){r.render("error",{error:e})}}),o.get("/authors/new",(e,r)=>{r.render("authors/new",{pageTitle:"Add Author"})}),o.post("/authors",async(e,r)=>{try{if(!e.body.authorName)throw"Enter author name.";const t=new n({name:e.body.authorName});await t.save(),r.redirect("/authors")}catch(e){r.render("error",{pageTitle:"Error",error:e,backButton:"/authors/new"})}}),o.get("/authors/:id",async(e,r)=>{try{const t=await n.findById(e.params.id),o=await a.find({author:t._id});r.render("authors/show",{pageTitle:t.name,author:t,booksByAuthor:o})}catch(e){r.render("error",{error:e})}}),o.put("/authors/:id",async(e,r)=>{try{const t=await n.findById(e.params.id);t.name=e.body.authorName,await t.save(),r.redirect("/authors/"+e.params.id)}catch(e){r.render("error",{error:e})}}),o.get("/authors/:id/edit",async(e,r)=>{try{const t=await n.findById(e.params.id);r.render("authors/edit",{pageTitle:"Edit "+t.name,author:t})}catch(e){r.render("error",{error:e})}}),o.delete("/authors/:id",async(e,r)=>{try{const t=await n.findById(e.params.id);await t.remove(),r.redirect("/authors")}catch(e){r.render("error",{error:e,backButton:"/authors"})}}),e.exports=o},function(e,r,t){const o=t(0).Router(),n=t(1),a=t(3);o.get("/books",async(e,r)=>{try{let t=n.find();e.query.title&&(t=t.where("title").regex(new RegExp(e.query.title,"i"))),e.query.publishAfter&&(t=t.where("publishDate").gte(e.query.publishAfter)),e.query.publishBefore&&(t=t.where("publishDate").lte(e.query.publishBefore));const o=await t.exec();r.render("books/index",{pageTitle:"Books",searchOptions:e.query,books:o})}catch(e){r.render("error",{backButton:"/books",error:e})}}),o.get("/books/new",async(e,r)=>{const t=await a.find({});r.render("books/new",{pageTitle:"Add Book",authors:t})}),o.post("/books",async(e,r)=>{const t=["bookTitle","bookDescription","bookPublishDate","bookAuthor"];try{t.forEach(r=>{if(!e.body[r])throw"Enter "+r});const o=new n({title:e.body.bookTitle,description:e.body.bookDescription,publishDate:e.body.bookPublishDate,author:e.body.bookAuthor}),a=JSON.parse(e.body.cover),i=["image/jpeg","image/jpg","image/png","image/gif"];a&&i.includes(a.type)&&(o.coverImage=new Buffer.from(a.data,"base64"),o.coverImageType=a.type),await o.save(),r.redirect("/books")}catch(e){r.render("error",{pageTitle:"Error",error:e,backButton:"/books/new"})}}),e.exports=o},function(e,r){e.exports=require("http")},function(e,r){e.exports=require("chalk")}]);